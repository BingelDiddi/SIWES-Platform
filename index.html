<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SIWES Platform - Login</title>
    <link href="style.css" rel="stylesheet" />
  </head>

  <body>
    <div class="login-container">
      <div class="login-header">
        <div class="logo-circle">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path
              d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
            />
            <polyline points="14 2 14 8 20 8" />
            <line x1="16" y1="13" x2="8" y2="13" />
            <line x1="16" y1="17" x2="8" y2="17" />
            <polyline points="10 9 9 9 8 9" />
          </svg>
        </div>
        <h1>SIWES Platform</h1>
        <p>Student Industrial Work Experience Scheme</p>
      </div>

      <div class="error-message" id="errorMessage">
        Invalid email or password.
      </div>

      <form class="login-form" id="loginForm">
        <div class="form-group">
          <label for="email">Email Address</label>
          <input
            type="email"
            id="email"
            name="email"
            placeholder="Enter your email"
            required
          />
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input
            type="password"
            id="password"
            name="password"
            placeholder="Enter your password"
            required
          />
        </div>
        <button type="submit" class="login-button">Login</button>
        <div class="spinner"></div>
      </form>
    </div>

    <script>
      const API_BASE = "http://127.0.0.1:8000/api";
      const loginForm = document.getElementById("loginForm");
      const errorMessage = document.getElementById("errorMessage");

      loginForm.addEventListener("submit", async function (event) {
        event.preventDefault();
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;

        try {
          // Show spinner
          document.querySelector(".login-button").style.display = "none";
          document.querySelector(".spinner").style.display = "block";
          // 1. Get Token
          const response = await fetch(`${API_BASE}/token/`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });

          if (!response.ok) throw new Error("Invalid credentials");

          const data = await response.json();
          // Store the token securely
          sessionStorage.setItem("accessToken", data.access);
          sessionStorage.setItem("refreshToken", data.refresh);

          // 2. Fetch User Profile to get the ROLE
          // We use the token we just got to ask "Who am I?"
          const profileResponse = await fetch(`${API_BASE}/profile/`, {
            headers: { Authorization: `Bearer ${data.access}` },
          });

          if (profileResponse.ok) {
            const profile = await profileResponse.json();

            // 3. Redirect based on the REAL Database Role
            if (profile.role === "student") {
              window.location.href = "student-dashboard.html";
            } else if (profile.role === "supervisor") {
              window.location.href = "supervisor-dashboard.html";
            } else if (profile.role === "admin") {
              window.location.href = "admin-dashboard.html";
            } else {
              throw new Error("Unknown user role");
            }
          } else {
            throw new Error("Could not fetch user profile");
          }
        } catch (error) {
          // hide spinner
          document.querySelector(".login-button").style.display = "block";
          document.querySelector(".spinner").style.display = "none";
          console.error(error);
          errorMessage.textContent =
            "Login Failed. Please check your email/password.";
          errorMessage.classList.add("show");
          setTimeout(() => errorMessage.classList.remove("show"), 5000);
        }
      });

      // Clear session on load to ensure clean login
      window.addEventListener("load", () => sessionStorage.clear());
    </script>
  </body>
</html>
